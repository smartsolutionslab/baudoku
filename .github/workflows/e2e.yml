name: E2E Tests

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Daily at 3 AM UTC

permissions:
  contents: read

jobs:
  check-changes:
    name: Check for Recent Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: development
          fetch-depth: 0

      - name: Check for commits in last 24h
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            RECENT=$(git log --since="24 hours ago" --oneline | head -1)
            if [ -n "$RECENT" ]; then
              echo "has_changes=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
              echo "No commits in the last 24 hours â€” skipping E2E."
            fi
          fi

  e2e-android:
    name: E2E Tests (Android)
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    timeout-minutes: 45
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: development

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android/sdk/system-images/android-{28,29,30,31,32,33}*
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          df -h /

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: src/package-lock.json

      - name: Install frontend dependencies
        working-directory: src
        run: npm ci

      - name: Expo prebuild
        working-directory: src/frontend
        run: npx expo prebuild --platform android --no-install

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Build debug APK
        working-directory: src/frontend/android
        run: ./gradlew assembleDebug --no-daemon

      - name: Run Maestro flows
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          emulator-options: -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect
          script: |
            adb install src/frontend/android/app/build/outputs/apk/debug/app-debug.apk
            maestro test e2e/flows/

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results
          path: ~/.maestro/tests/
          retention-days: 14
